<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¿˜å‰©å‡ å°æ—¶ï¼Ÿ</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e3c72">
<link rel="apple-touch-icon" href="/icons/clock-192.png">

<!-- ===== å¿…è¦å¤–éƒ¨åº“ï¼ˆExcel + PDFï¼‰ ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: "Microsoft YaHei";
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    margin:0;
}
.container{
    max-width: 900px;
    margin:0 auto;
    background:white;
    min-height:100vh;
    padding:15px;
}
.header{
    background:#1e3c72;
    color:white;
    padding:12px;
    text-align:center;
    font-size:20px;
    border-radius:8px;
}
.section{
    border:1px solid #ddd;
    padding:15px;
    margin:10px 0;
    border-radius:10px;
}
.flex{ display:flex; gap:10px; flex-wrap:wrap; }
.card{
    flex:1;
    padding:12px;
    border-radius:10px;
    text-align:center;
    min-width:150px;
}
.balance-card{ background:#e8f5e9; }
.debt-card{ background:#ffebee; }

button{
    padding:10px;
    border:none;
    border-radius:8px;
    color:white;
    margin:5px 0;
    cursor:pointer;
}
.deposit{ background:#2ecc71; }
.withdraw{ background:#e74c3c; }
.loan{ background:#f39c12; }
.repay{ background:#8e44ad; }
.save{ background:#3498db; }
.reset{ background:#95a5a6; }

.export{ background:#2980b9; }
.export-json{ background:#34495e; }
.export-excel{ background:#27ae60; }
.export-pdf{ background:#c0392b; }

.clear-term{ background:#16a085; }

table{ width:100%; border-collapse: collapse; }
th,td{
    border:1px solid #ddd;
    padding:6px;
    text-align:center;
    font-size:14px;
}
canvas{
    width:100%;
    height:320px;
    border:1px solid #ddd;
}
.gray{ background:#eee; color:#aaa; }
</style>
</head>

<body>
<div class="container">

<div class="header">ğŸ¦ è¿˜å‰©å‡ å°æ—¶ï¼Ÿ</div>

<div class="section flex">
  <div class="card balance-card">
    <h3>å½“å‰ä½™é¢</h3>
    <h2>Â¥ <span id="balance">0.00</span></h2>
  </div>
  <div class="card debt-card">
    <h3>å‰©ä½™æ¬ æ¬¾</h3>
    <h2>Â¥ <span id="debt">0.00</span></h2>
  </div>
</div>

<!-- ===== å­˜å–æ¬¾ ===== -->
<div class="section">
<h3>ğŸ’° å­˜å–æ¬¾</h3>
é‡‘é¢ï¼š<br>
<input type="number" id="amount" placeholder="è¾“å…¥é‡‘é¢"><br>
åŸå› ï¼š<br>
<input type="text" id="reason" placeholder="è¯·è¾“å…¥å­˜/å–æ¬¾åŸå› "><br><br>
<button class="deposit" onclick="deposit()">å­˜å…¥</button>
<button class="withdraw" onclick="withdraw()">å–å‡º</button>
</div>

<!-- ===== è´·æ¬¾ ===== -->
<div class="section">
<h3>ğŸ¦ ç”³è¯·è´·æ¬¾</h3>
è´·æ¬¾é‡‘é¢ï¼š<br>
<input type="number" id="loanAmount" placeholder="è´·æ¬¾é‡‘é¢"><br>
åˆ©ç‡ %ï¼š<br>
<input type="number" id="interest" placeholder="ä¾‹å¦‚ï¼š5"><br>
æ€»æœŸæ•°ï¼ˆè‡ªå®šä¹‰ï¼‰ï¼š<br>
<input type="number" id="terms" placeholder="ä¾‹å¦‚ï¼š10"><br><br>
<button class="loan" onclick="takeLoan()">ç”³è¯·è´·æ¬¾</button>
<p id="loanInfo"></p>
</div>

<!-- ===== è¿˜æ¬¾ ===== -->
<div class="section">
<h3>ğŸ’¸ è¿˜æ¬¾</h3>
è¿˜æ¬¾é‡‘é¢ï¼š<br>
<input type="number" id="repayAmount" placeholder="è¿˜æ¬¾é‡‘é¢"><br>
<button class="repay" onclick="repay()">ç«‹å³è¿˜æ¬¾</button>
</div>

<!-- ===== åˆ†æœŸè¡¨ ===== -->
<div class="section">
<h3>ğŸ“… è¿˜æ¬¾åˆ†æœŸè¡¨</h3>
<table>
<tr>
<th>æœŸæ•°</th><th>æ¯æœŸåº”è¿˜</th><th>æ“ä½œ</th>
</tr>
<tbody id="schedule"></tbody>
</table>
</div>

<!-- ===== å›¾è¡¨ç­›é€‰ ===== -->
<div class="section">
<h3>ğŸ“ˆ ä½™é¢æ›²çº¿ï¼ˆå¯é€‰æ—¶é—´æ®µï¼‰</h3>
èµ·å§‹æ—¥æœŸï¼š
<input type="date" id="startDate">
ç»“æŸæ—¥æœŸï¼š
<input type="date" id="endDate">
<button onclick="drawChart()">ç­›é€‰å¹¶é‡ç”»</button>
<canvas id="chart"></canvas>
</div>

<!-- ===== äº¤æ˜“è®°å½• ===== -->
<div class="section">
<h3>ğŸ“œ äº¤æ˜“è®°å½•ï¼ˆå¯æŒ‰æ—¥æœŸç­›é€‰ï¼‰</h3>
<table>
<tr>
<th>æ—¶é—´</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>ä½™é¢</th><th>å‰©ä½™æ¬ æ¬¾</th><th>åŸå› </th>
</tr>
<tbody id="history"></tbody>
</table>
</div>

<!-- ====== æ–°å¢ï¼šä¸‰ç§å¯¼å‡º ====== -->
<div class="section">
<h3>ğŸ“¤ æ•°æ®å¯¼å‡ºï¼ˆå¯è·¨è®¾å¤‡ + æŠ¥å‘Šï¼‰</h3>

<button class="export-json" onclick="exportAllJSON()">
ğŸ“¦ å¯¼å‡ºå…¨éƒ¨æ•°æ®ï¼ˆJSONï¼‰
</button>

<button class="export-json" onclick="exportFilteredJSON()">
ğŸ“¦ å¯¼å‡ºæ—¶é—´æ®µ JSON
</button>

<button class="export-excel" onclick="exportExcel()">
ğŸ“Š å¯¼å‡ºæ—¶é—´æ®µ Excel
</button>

<button class="export-pdf" onclick="exportPDF()">
ğŸ“„ å¯¼å‡ºæ—¶é—´æ®µ PDFï¼ˆå«å›¾è¡¨ï¼‰
</button>

</div>

<div class="section">
<button class="save" onclick="saveData()">ä¿å­˜æ•°æ®</button>
<button class="reset" onclick="resetData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
</div>

</div>

<script>
let balance = parseFloat(localStorage.getItem("balance") || 0);
let debt = parseFloat(localStorage.getItem("debt") || 0);
let history = JSON.parse(localStorage.getItem("history") || "[]");
let schedule = JSON.parse(localStorage.getItem("schedule") || "[]");

/* ========== ç¾åŒ–æ—¶é—´ ========== */
function formatTime(iso){
  let d = new Date(iso);
  let y = d.getFullYear();
  let m = String(d.getMonth()+1).padStart(2,'0');
  let day = String(d.getDate()).padStart(2,'0');
  let h = String(d.getHours()).padStart(2,'0');
  let min = String(d.getMinutes()).padStart(2,'0');
  let s = String(d.getSeconds()).padStart(2,'0');
  return `${y}-${m}-${day} ${h}:${min}:${s}`;
}

/* ========== UI ========== */
function updateUI(){
    document.getElementById("balance").innerText = balance.toFixed(2);
    document.getElementById("debt").innerText = debt.toFixed(2);

    let h = document.getElementById("history");
    h.innerHTML = "";

    let start = startDate.value ? new Date(startDate.value) : null;
    let end = endDate.value ? new Date(endDate.value) : null;

    history.forEach(r=>{
        let t = new Date(r.time);
        if(start && t < start) return;
        if(end && t > end) return;

        h.innerHTML += `
        <tr>
        <td>${formatTime(r.time)}</td>
        <td>${r.type}</td>
        <td>Â¥${r.amount}</td>
        <td>Â¥${r.balance}</td>
        <td>Â¥${r.debt}</td>
        <td>${r.reason || ""}</td>
        </tr>`;
    });

    let s = document.getElementById("schedule");
    s.innerHTML = "";
    schedule.forEach((r,i)=>{
        s.innerHTML += `
        <tr class="${r.done?'gray':''}">
        <td>${i+1}</td>
        <td>Â¥${r.pay}</td>
        <td>
        ${r.done?'å·²æ¸…é›¶':`<button class="clear-term" onclick="clearTerm(${i})">æœ¬æœŸè¿˜æ¸…</button>`}
        </td>
        </tr>`;
    });

    drawChart();
}

function addRecord(type, amount, reason=""){
    history.push({
        time: new Date().toISOString(),
        type:type,
        amount:amount.toFixed(2),
        balance:balance.toFixed(2),
        debt:debt.toFixed(2),
        reason:reason
    });
}

/* ========== å­˜å–æ¬¾ ========== */
function deposit(){
    let amt = parseFloat(amount.value);
    let rs = reason.value.trim();
    if(!rs){ alert("è¯·è¾“å…¥åŸå› "); return; }
    if(isNaN(amt) || amt<=0){ alert("é‡‘é¢æ— æ•ˆ"); return; }

    balance += amt;
    addRecord("å­˜å…¥", amt, rs);
    updateUI();
}

function withdraw(){
    let amt = parseFloat(amount.value);
    let rs = reason.value.trim();
    if(!rs){ alert("è¯·è¾“å…¥åŸå› "); return; }
    if(isNaN(amt) || amt<=0){ alert("é‡‘é¢æ— æ•ˆ"); return; }
    if(amt > balance){ alert("ä½™é¢ä¸è¶³"); return; }

    balance -= amt;
    addRecord("å–å‡º", amt, rs);
    updateUI();
}

/* ========== è´·æ¬¾ ========== */
function takeLoan(){
    let L = parseFloat(loanAmount.value);
    let r = parseFloat(interest.value)/100;
    let N = parseInt(terms.value);

    if(isNaN(L)||isNaN(r)||isNaN(N)||N<=0){
        alert("è¯·å¡«å†™å®Œæ•´ä¸”æœŸæ•°>0"); return;
    }

    let totalRepay = L + L*r;
    let payPerTerm = totalRepay / N;

    balance += L;
    debt += totalRepay;
    addRecord("è´·æ¬¾åˆ°è´¦", L, "è´·æ¬¾");

    schedule = [];
    for(let i=0;i<N;i++){
        schedule.push({ pay: payPerTerm.toFixed(2), done:false });
    }

    loanInfo.innerText =
    `åº”è¿˜æ€»é¢ Â¥${totalRepay.toFixed(2)}ï¼Œæ¯æœŸ Â¥${payPerTerm.toFixed(2)}ï¼Œå…± ${N} æœŸ`;

    updateUI();
}

/* ========== é€æœŸæ¸…é›¶ ========== */
function clearTerm(i){
    let p = parseFloat(schedule[i].pay);

    if(balance < p){
        alert("ä½™é¢ä¸è¶³ä»¥æ¸…æœ¬æœŸ"); return;
    }

    balance -= p;
    debt = Math.max(0, debt - p);
    schedule[i].done = true;
    addRecord("è¿˜æ¬¾ï¼ˆç¬¬"+(i+1)+"æœŸï¼‰", p, "åˆ†æœŸè¿˜æ¬¾");

    if(schedule.every(s=>s.done)){
        alert("ğŸ‰ æ‰€æœ‰æ¬ æ¬¾å·²è¿˜æ¸…ï¼");
    }
    updateUI();
}

/* ========== æ™®é€šè¿˜æ¬¾ ========== */
function repay(){
    let amt = parseFloat(repayAmount.value);
    if(isNaN(amt)||amt<=0){ alert("é‡‘é¢æ— æ•ˆ"); return; }
    if(balance <= 0){ alert("ä½™é¢ä¸è¶³"); return; }

    let realPay = Math.min(amt, debt);
    balance -= realPay;
    debt -= realPay;
    addRecord("è¿˜æ¬¾", realPay, "ä¸»åŠ¨è¿˜æ¬¾");

    if(debt === 0){
        alert("ğŸ‰ æ¬ æ¬¾å·²å…¨éƒ¨ç»“æ¸…ï¼");
    }
    updateUI();
}

/* ========== é«˜æ¸…å›¾è¡¨ ========== */
function drawChart(){
    let c = document.getElementById("chart");
    let ctx = c.getContext("2d");

    let ratio = window.devicePixelRatio || 1;
    c.width = c.offsetWidth * ratio;
    c.height = c.offsetHeight * ratio;
    ctx.scale(ratio, ratio);

    ctx.clearRect(0,0,c.width,c.height);

    let start = startDate.value ? new Date(startDate.value) : null;
    let end = endDate.value ? new Date(endDate.value) : null;

    let data = history.filter(r=>{
        let t = new Date(r.time);
        if(start && t < start) return false;
        if(end && t > end) return false;
        return true;
    });

    if(data.length < 2) return;

    let b = data.map(r=>parseFloat(r.balance));
    let max = Math.max(...b);
    let min = Math.min(...b);
    let step = (c.offsetWidth-60)/(b.length-1);

    ctx.beginPath();
    ctx.moveTo(40,10);
    ctx.lineTo(40,c.offsetHeight-30);
    ctx.lineTo(c.offsetWidth-10,c.offsetHeight-30);
    ctx.stroke();

    ctx.beginPath();
    data.forEach((r,i)=>{
        let v = parseFloat(r.balance);
        let y = 10 + (max-v)/(max-min||1)*(c.offsetHeight-40);
        let x = 40 + i*step;
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    });
    ctx.strokeStyle="#1e3c72";
    ctx.lineWidth = 2;
    ctx.stroke();
}

/* ================== æ–°å¢å¯¼å‡º ================== */

// 3ï¸âƒ£ å¯¼å‡ºæ—¶é—´æ®µ Excel
function exportExcel(){
  let start = startDate.value ? new Date(startDate.value) : null;
  let end = endDate.value ? new Date(endDate.value) : null;

  let filtered = history.filter(r=>{
    let t = new Date(r.time);
    if(start && t < start) return false;
    if(end && t > end) return false;
    return true;
  });

  let sheet1 = XLSX.utils.json_to_sheet(filtered);
  let sheet2 = XLSX.utils.json_to_sheet(schedule);

  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, sheet1, "äº¤æ˜“è®°å½•");
  XLSX.utils.book_append_sheet(wb, sheet2, "åˆ†æœŸè¡¨");

  XLSX.writeFile(wb,
   `bank-report-${startDate.value||'all'}-to-${endDate.value||'all'}.xlsx`);
}

// 4ï¸âƒ£ å¯¼å‡ºæ—¶é—´æ®µ PDFï¼ˆå«å›¾è¡¨ï¼‰
function exportPDF(){
  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();

  doc.text("é“¶è¡ŒæŠ¥å‘Š", 10, 10);
  doc.text(`ä½™é¢ï¼šÂ¥${balance.toFixed(2)}`, 10, 20);
  doc.text(`æ¬ æ¬¾ï¼šÂ¥${debt.toFixed(2)}`, 10, 30);

  let imgData = document.getElementById("chart").toDataURL("image/png");
  doc.addImage(imgData, "PNG", 10, 40, 180, 90);

  doc.save(
   `bank-report-${startDate.value||'all'}-to-${endDate.value||'all'}.pdf`
  );
}

/* ========== ä¿å­˜ ========== */
function saveData(){
    localStorage.setItem("balance", balance);
    localStorage.setItem("debt", debt);
    localStorage.setItem("history", JSON.stringify(history));
    localStorage.setItem("schedule", JSON.stringify(schedule));
    alert("å·²ä¿å­˜");
}

function resetData(){
    if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")){
        localStorage.clear();
        balance=0; debt=0; history=[]; schedule=[];
        updateUI();
    }
}

updateUI();

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
